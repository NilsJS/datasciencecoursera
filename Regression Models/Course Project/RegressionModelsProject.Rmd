---
title: "Regression Models - Course Project"
output: 
    pdf_document:
        fig_caption: yes
includes:
  in_header: mystyles.sty
---

```{r, results="hide", echo=FALSE}
# Load libraries
library(dplyr, quietly=TRUE, warn.conflicts = FALSE)
suppressWarnings(library(scales, quietly=TRUE))
suppressWarnings(library(pander, quietly=TRUE))
library(ggplot2)
suppressWarnings(library(gridExtra, quietly=TRUE, warn.conflict=FALSE))

library(datasets)
```


```{r echo = FALSE}
data(mtcars)

#mtcars$am = as.character(mtcars$am)
#mtcars$transtype = 1
#mtcars[with(mtcars, am == 1),]$transtype = 2
automatic <- subset(mtcars, am == 1)
manual <- subset(mtcars, am == 0)
```

**Using the mtcars data set, answer the following two questions:**

* "Is an automatic or manual transmission better for MPG"
* "Quantify the MPG difference between automatic and manual transmissions"

# Data eploration
The mtcars data set consists of `r nrow(mtcars)` rows, `r nrow(automatic)` with automatic and  `r nrow(manual)` with manual transmission.  Some key variables are:

* **mpg** = Miles(US)/gallon
* **am** = Transmission (0 = automatic, 1 = manual)
* **hp** = Gross horsepower 
* **wt** = Weight (lb/1000) 

```{r explore, echo = FALSE, fig.height = 4, fig.cap="\\label{fig:explore}Exploratory plots of Automatic vs Manual transmissions with engine power or weight"}
mtcars$am = as.character(mtcars$am)
g1 = ggplot(mtcars, aes(x=hp, y=mpg, color = am, size = wt)) +
    geom_point(alpha=.5) + 
    xlab("hp") + 
    ylab("mpg") +
    theme(legend.position="bottom")
#    ggtitle("Exploratory plot: Automatic vs Manual")
g2 = ggplot(mtcars, aes(x=wt, y=mpg, color = am, size = hp)) +
    geom_point(alpha=.5) + 
    xlab("wt") + 
    ylab("mpg") +
    theme(legend.position="bottom")
#    ggtitle("Exploratory plot: Automatic vs Manual")

grid.arrange(g1, g2, ncol=2)
mtcars$am = as.numeric(mtcars$am)
```

The scatter plots in Figure \ref{fig:explore} have cars with automatic transmission in cyan and those with manual in salmon.  With both these plots we see that automatic cars generally have higher mpg, but it is clear that both weight and engine power has a negative impact on mpg. Lighter or smaller engine automatic cars seem to cluster in the upper left quadrant, and are more fuel efficient than heavy and/or powerful manual cars which seem overly represented in the lower right quadrant.  In both plots there are two high-hp and heavy outliers in the automatic segment, which both have poor mpg.

* $H_0$ : mpg for automatic transmission $=$ mpg for manual transmission
* $H_a$ : mpg for automatic transmission $\ne$ mpg for manual transmission


## Regression Models

```{r}
fit1 <- lm(mpg ~ am, mtcars)
fit2 <- lm(mpg ~ am + hp, mtcars)
fit3 <- lm(mpg ~ am + hp + wt, mtcars)
```

```{r echo = FALSE}
coef1 <- summary(fit1)$coef
panderOptions('table.split.table', Inf) 
pander(coef1, style="rmarkdown") #, caption="Model 1 Coefficients for mpg by transmission type")
```

#### Model 1
With the simple *fit1* model it looks like cars with automatic transmission are more fuel efficient than those with manual transmission.  The mean mpg, automatic = `r round(mean(automatic$mpg), 3)` and manual = `r round(mean(manual$mpg), 3)`, does differ in automatic's favour.  The coefficients can be interpreted as simply going to automatic transmission will gain you `r round(coef1[2,1], 3)` mpg.  

```{r echo = FALSE}
coef2 <- summary(fit2)$coef
panderOptions('table.split.table', Inf) 
pander(coef2, style="rmarkdown") #, caption="Model 2 Coefficients for mpg by transmission and hp")
```

#### Model 2
As the initial exploration indicated, engine power (hp) does seem to have an impact, as more cars with large engines had manual transmission. The *fit2* model accounts for that, and we can see that engine size does negatively impact fuel efficiency.  Adding one hp decreases fuel efficiency by `r abs(round(coef2[3,1], 3))` mpg.  The effect of an automatic will now gain you `r round(coef2[2,1], 3)` mpg, providing hp stays the same.

```{r echo = FALSE}
coef3 <- summary(fit3)$coef
panderOptions('table.split.table', Inf) 
pander(coef3, style="rmarkdown") #, caption="Model 3 Coefficients for mpg by transmission + hp and wt")
```

#### Model 3
Heavy cars often come with large engines and many of these have manual transmission. The *fit3* model accounts for weight *wt* as well as engine power *hp*.  We see that adding 1000lb of weight reduces mpg by `r abs(round(coef3[4,1], 3))`. Adding this third factor, reduces the impact of the other two, so that adding one hp now decreases mpg by `r abs(round(coef3[3,1], 3))`, and finally an automatic transmission will only gain you `r round(coef3[2,1], 3)` mpg, provided hp and wt stays the same. Figure \ref{fig:mod3} in the appendix draws these relationship in a single plot

```{r echo = FALSE}
# Confidence interval for the intercept and the slope
coef <- summary(fit3)$coef
am_ci <- coef[2,1] + c(1,-1)*qt(.975, df=fit3$df) * coef[2,2]
hp_ci <- coef[3,1] + c(1,-1)*qt(.975, df=fit3$df) * coef[3,2]
wt_ci <- coef[4,1] + c(1,-1)*qt(.975, df=fit3$df) * coef[4,2]
```

**However:** adding more factors to our model has also increased the *p-value* for am to `r round(coef3[2,4], 3)` so that it now exceeds the customary cutof of 0.05.  **We therefore cannot reject $H_0$ using this model.**  The confidence interval for the slope of the am predictor  (`r round(am_ci[1], 4)` ;  `r round(am_ci[2], 4)`) includes 0 which means it may have no impact.  The residual variability $\sigma$ is `r round(summary(fit3)$sigma, 4)`, and the residual plots in Figure \ref{fig:resid} in the appendix a vague "curved" trend indicating that a linear model might not be the best fit. All in all this indicates that our model is a bad fit or that we simply do not have enough data in our sample.

# Appendix : plots

```{r echo=FALSE}
mtcars$am = as.character(mtcars$am)
mtcars$Residual <- resid(fit3) 
```

```{r mod3, echo = FALSE, fig.height = 3.5, fig.width=automatic, fig.cap="\\label{fig:mod3}Model3: mpg ~ am + hp + wt"}
ggplot(mtcars, aes(x=hp, y=mpg, color = am, size = wt)) +
  geom_point(alpha=.5) + 
  geom_smooth(method = "lm", size = 2) +
  geom_vline(xintercept = mean(automatic$hp), color = "cyan", alpha=.5) +
  geom_hline(yintercept = mean(automatic$mpg), color = "cyan", alpha=.5) +
  geom_vline(xintercept = mean(manual$hp), color = "salmon", alpha=.5) +
  geom_hline(yintercept = mean(manual$mpg), color = "salmon", alpha=.5)
#  xlab("HP") + 
#  ylab("Miles per gallon") 
#  ggtitle("Model3: Automatic vs Manual by HP & Weight")
```

```{r resid, echo = FALSE, fig.height = 3, fig.width=automatic, fig.cap="\\label{fig:resid}Residual plots for model 3"}
g1 <- ggplot(mtcars, aes(x=hp, y=Residual, size = wt, color = am)) +
      geom_point(alpha=.5) + 
      geom_hline(yintercept = 0, color = "black") +
      theme(legend.position="bottom")
g2 <- ggplot(mtcars, aes(x=wt, y=Residual, size = hp, color = am)) +
      geom_point(alpha=.5) + 
      geom_hline(yintercept = 0, color = "black") +
      theme(legend.position="bottom")
grid.arrange(g1, g2, ncol=2)
```

```{r echo = FALSE}
#g1 = ggplot(mtcars, aes(x=am, y=mpg, color = am)) +
#    geom_point(alpha=.5) + 
#    stat_smooth(method= glm, family=binomial) +
#    geom_hline(yintercept = mean(automatic$mpg), color = "cyan", alpha=.5) +
#    geom_hline(yintercept = mean(manual$mpg), color = "salmon", alpha=.5) +
#    geom_abline(yintercept = 10, slope = coef1[2,1], color = "black", size = 2) +
#    xlab("Transmission type (0 = manual, 1 = automatic)") + 
#    ylab("Miles per gallon") + 
#    ggtitle("Model 1: Automatic vs Manual, with means")
#g1
```

```{r echo = FALSE}
#g2 = ggplot(mtcars, aes(x=hp, y=mpg, color = am)) +
#    geom_point(alpha=.5) + 
#    geom_smooth(method = "lm", size = 2) +
#    xlab("HP") + 
#    ylab("Miles per gallon") + 
#    ggtitle("Model 2: Automatic vs Manual by HP")
```


# Initial draft
```{r echo = FALSE}
afit <- lm(mpg ~ I(hp - mean(hp)), automatic)
acoef <- summary(afit)$coef
panderOptions('table.split.table', Inf) 
pander(acoef, style="rmarkdown", caption="Model3 Coefficients for Automatic (centered at mean hp)")

mfit <- lm(mpg ~ I(hp - mean(hp)), manual)
mcoef <- summary(mfit)$coef
panderOptions('table.split.table', Inf) 
pander(mcoef, style="rmarkdown", caption="LM Coefficients for Manual (centered at mean hp)")
```

An *automatic* car of average engine power, `r round(mean(automatic$hp), 0)` hp, runs `r round(mean(automatic$mpg), 2)` mpg, compared to *manual* cars of average engine power, `r round(mean(manual$hp), 0)`hp, runs `r round(mean(manual$mpg), 2)` mpg.  Manual cars do tend to have larger engines which do consume more fuel, but adding an additional HP of engine power to an automatic car will result in `r round(acoef[2,1], 4)` change in MPG, which is very similar to manual cars (`r round(mcoef[2,1], 4)`), assuming we ignore weight in this data set.

#### Interpretation of Coefficients.   
Our model estimates a decrease of `r abs(round(acoef[2,1], 4))` miles per gallon for every 1 added horse power to a car with an automatic transmission, and a decrease of `r abs(round(mcoef[2,1], 4))` miles per gallon for every 1 added horse power to a car with a manual transmission.

From the slope alone there is not much difference in fuel efficiency between the transmission types, but from the scatterplot we see that the confidence interval is much wider for automatic than it is for manual cars.The below plot of the residuals will shows the difference in spread here.

```{r echo = FALSE}
automatic$Residual <- resid(afit) 
manual$Residual <- resid(mfit) 

ga = ggplot(automatic, aes(x=hp, y=Residual, size = wt)) +
    geom_point(alpha=.5, color = "cyan") + 
    geom_hline(yintercept = 0, color = "black") +
    ggtitle("Automatic Residuals")
#    xlab("HP") + 
#    ylab("Miles per gallon") + 

gm = ggplot(manual, aes(x=hp, y=Residual, size = wt)) +
    geom_point(alpha=.5, color = "salmon") + 
    geom_hline(yintercept = 0, color = "black") +
    ggtitle("Manual Residuals")

grid.arrange(ga, gm, nrow=2)

```

```{r}
# Confidence interval for the intercept and the slope
aintercept_ci <- acoef[1,1] + c(1,-1)*qt(.975, df=afit$df) * acoef[1,2]
aslope_ci <- acoef[2,1] + c(1,-1)*qt(.975, df=afit$df) * acoef[2,2]

mintercept_ci <- mcoef[1,1] + c(1,-1)*qt(.975, df=mfit$df) * mcoef[1,2]
mslope_ci <- mcoef[2,1] + c(1,-1)*qt(.975, df=mfit$df) * mcoef[2,2]
```

## MPG difference between automatic and manual transmission

| Transmission type | MPG $\Delta$ per added HP | Conf int (slope) | $\sigma$ / Residual variability |
|:-----------------:|:---------------------------:|:---------------:|:-----------------:|
| Automatic         | `r round(acoef[2,1], 4)`    |  (`r round(aslope_ci[1], 4)`;  `r round(aslope_ci[2], 4)`)  | `r round(summary(afit)$sigma, 4)`  |
| Manual            | `r round(mcoef[2,1], 4)`    | (`r round(mslope_ci[1], 4)`; `r round(mslope_ci[2], 4)`)  | `r round(summary(mfit)$sigma, 4)`  |


**Grading criteria:**

* Did the student interpret the coefficients correctly?
* Did the student do some exploratory data analyses?
* Did the student fit multiple models and detail their strategy for model selection?
* Did the student answer the questions of interest or detail why the question(s) is (are) not answerable?
* Did the student do a residual plot and some diagnostics?
* Did the student quantify the uncertainty in their conclusions and/or perform an inference correctly?
* Was the report brief (about 2 pages long) for the main body of the report and no longer than 5 with supporting appendix of figures?
* Did the report include an executive summary?
* Was the report done in Rmd (knitr)?


# Executive Summary

