---
title: "Regression Models - Course Project"
output: pdf_document
includes:
  in_header: mystyles.sty
---

```{r, results="hide", echo=FALSE}
# Load libraries
library(dplyr, quietly=TRUE, warn.conflicts = FALSE)
suppressWarnings(library(scales, quietly=TRUE))
suppressWarnings(library(pander, quietly=TRUE))
library(ggplot2)
suppressWarnings(library(gridExtra, quietly=TRUE, warn.conflict=FALSE))

library(datasets)
```


**Using the mtcars data set, answer the following two questions:**

* "Is an automatic or manual transmission better for MPG"
* "Quantify the MPG difference between automatic and manual transmissions"

# Exploratory Analysis
```{r echo = FALSE}
data(mtcars)

#mtcars$am = as.character(mtcars$am)
#mtcars$transtype = 1
#mtcars[with(mtcars, am == 1),]$transtype = 2
automatic <- subset(mtcars, am == 1)
manual <- subset(mtcars, am == 0)
```

```{r echo = FALSE}
mtcars$am = as.character(mtcars$am)
g = ggplot(mtcars, aes(x=hp, y=mpg, color = am, size = wt)) +
    geom_point(alpha=.5) + 
    xlab("HP") + 
    ylab("Miles per gallon") + 
    ggtitle("Automatic vs Manual")
g
mtcars$am = as.numeric(mtcars$am)
```

The mtcars data set consists of `r nrow(mtcars)` rows, `r nrow(automatic)` with automatic and  `r nrow(manual)` with manual transmission.  Some key variables are:

* **mpg** = Miles(US)/gallon
* **am** = Transmission (0 = automatic, 1 = manual)
* **hp** = Gross horsepower 
* **wt** = Weight (lb/1000) 

The above scatter plot has cars with automatic transmission in cyan and those with manual in salmon.  The x axis indicates engine power (hp) and the size of the dots indicate weight. Lighter automatic cars seem to cluster in the upper left quadrant, and are more fuel efficient than heavy manual cars which seem overly represented in the lower right quadrant.  

## Regression Models

```{r}
fit1 <- lm(mpg ~ am, mtcars)
fit2 <- lm(mpg ~ am + hp, mtcars)
fit3 <- lm(mpg ~ am + hp + wt, mtcars)
```

```{r echo = FALSE}
coef1 <- summary(fit1)$coef
panderOptions('table.split.table', Inf) 
pander(coef1, style="rmarkdown") #, caption="Model 1 Coefficients for mpg by transmission type")
```

#### Model 1
With the simple *fit1* model it looks like cars with automatic transmission are more fuel efficient than those with manual transmission.  The mean mpg, automatic = `r round(mean(automatic$mpg), 3)` and manual = `r round(mean(manual$mpg), 3)`, does differ in automatic's favour.  The coefficients can be interpreted as simply going to automatic transmission will gain you `r round(coef1[2,1], 3)` mpg.  

```{r echo = FALSE}
coef2 <- summary(fit2)$coef
panderOptions('table.split.table', Inf) 
pander(coef2, style="rmarkdown") #, caption="Model 2 Coefficients for mpg by transmission and hp")
```

#### Model 2
As the initial exploration indicated, engine power (hp) does seem to have an impact, as more cars with large engines had manual transmission. The *fit2* model accounts for that, and we can see that engine size does have a negatively impact.  Adding one hp decreases mpg by `r abs(round(coef2[3,1], 3))` mpg.  The effect of an automatic will now gain you `r round(coef2[2,1], 3)` mpg, providing hp stays the same.

```{r echo = FALSE}
coef3 <- summary(fit3)$coef
panderOptions('table.split.table', Inf) 
pander(coef3, style="rmarkdown") #, caption="Model 3 Coefficients for mpg by transmission + hp and wt")
```

#### Model 3
Heavy cars often come with large engines and many of these have manual transmission. The *fit3* model accounts for weight *wt* as well as engine power *hp*.  We see that this matches our intuition so that adding 1000lb of weight has a reduces mpg by `r round(coef3[4,1], 3)` mpg. Adding this third factor, lessens the impact on the other two, so that adding one hp decreases mpg by `r abs(round(coef3[3,1], 3))` mpg, and finally an automatic transmission will gain you `r round(coef3[2,1], 3)` mpg, provided hp and wt stays the same.


```{r echo = FALSE}
afit <- lm(mpg ~ I(hp - mean(hp)), automatic)
acoef <- summary(afit)$coef
panderOptions('table.split.table', Inf) 
pander(acoef, style="rmarkdown", caption="Model3 Coefficients for Automatic (centered at mean hp)")

mfit <- lm(mpg ~ I(hp - mean(hp)), manual)
mcoef <- summary(mfit)$coef
panderOptions('table.split.table', Inf) 
pander(mcoef, style="rmarkdown", caption="LM Coefficients for Manual (centered at mean hp)")
```

An *automatic* car of average engine power, `r round(mean(automatic$hp), 0)` hp, runs `r round(mean(automatic$mpg), 2)` mpg, compared to *manual* cars of average engine power, `r round(mean(manual$hp), 0)`hp, runs `r round(mean(manual$mpg), 2)` mpg.  Manual cars do tend to have larger engines which do consume more fuel, but adding an additional HP of engine power to an automatic car will result in `r round(acoef[2,1], 4)` change in MPG, which is very similar to manual cars (`r round(mcoef[2,1], 4)`), assuming we ignore weight in this data set.

#### Interpretation of Coefficients.   
Our model estimates a decrease of `r abs(round(acoef[2,1], 4))` miles per gallon for every 1 added horse power to a car with an automatic transmission, and a decrease of `r abs(round(mcoef[2,1], 4))` miles per gallon for every 1 added horse power to a car with a manual transmission.

From the slope alone there is not much difference in fuel efficiency between the transmission types, but from the scatterplot we see that the confidence interval is much wider for automatic than it is for manual cars.The below plot of the residuals will shows the difference in spread here.

```{r echo = FALSE}
automatic$Residual <- resid(afit) 
manual$Residual <- resid(mfit) 

ga = ggplot(automatic, aes(x=hp, y=Residual, size = wt)) +
    geom_point(alpha=.5, color = "cyan") + 
    geom_hline(yintercept = 0, color = "black") +
    ggtitle("Automatic Residuals")
#    xlab("HP") + 
#    ylab("Miles per gallon") + 

gm = ggplot(manual, aes(x=hp, y=Residual, size = wt)) +
    geom_point(alpha=.5, color = "salmon") + 
    geom_hline(yintercept = 0, color = "black") +
    ggtitle("Manual Residuals")

grid.arrange(ga, gm, nrow=2)

```

```{r}
# Confidence interval for the intercept and the slope
aintercept_ci <- acoef[1,1] + c(1,-1)*qt(.975, df=afit$df) * acoef[1,2]
aslope_ci <- acoef[2,1] + c(1,-1)*qt(.975, df=afit$df) * acoef[2,2]

mintercept_ci <- mcoef[1,1] + c(1,-1)*qt(.975, df=mfit$df) * mcoef[1,2]
mslope_ci <- mcoef[2,1] + c(1,-1)*qt(.975, df=mfit$df) * mcoef[2,2]
```

## MPG difference between automatic and manual transmission

| Transmission type | MPG $\Delta$ per added HP | Conf int (slope) | $\sigma$ / Residual variability |
|:-----------------:|:---------------------------:|:---------------:|:-----------------:|
| Automatic         | `r round(acoef[2,1], 4)`    |  (`r round(aslope_ci[1], 4)`;  `r round(aslope_ci[2], 4)`)  | `r round(summary(afit)$sigma, 4)`  |
| Manual            | `r round(mcoef[2,1], 4)`    | (`r round(mslope_ci[1], 4)`; `r round(mslope_ci[2], 4)`)  | `r round(summary(mfit)$sigma, 4)`  |



# Appendix : plots


```{r echo = FALSE}
mtcars$am = as.character(mtcars$am)
g = ggplot(mtcars, aes(x=am, y=mpg, color = am)) +
    geom_point(alpha=.5) + 
    geom_hline(yintercept = mean(automatic$mpg), color = "cyan", alpha=.5) +
    geom_hline(yintercept = mean(manual$mpg), color = "salmon", alpha=.5) +
#    geom_abline(yintercept = 10, slope = coef1[2,1], color = "black", size = 2) +
    xlab("Transmission type (0 = manual, 1 = automatic)") + 
    ylab("Miles per gallon") + 
    ggtitle("Model 1: Automatic vs Manual, with means")
g
```

```{r echo = FALSE}
g = ggplot(mtcars, aes(x=hp, y=mpg, color = am)) +
    geom_point(alpha=.5) + 
    geom_smooth(method = "lm", size = 2) +
    xlab("HP") + 
    ylab("Miles per gallon") + 
    ggtitle("Model 2: Automatic vs Manual by HP")
g
```

```{r echo = FALSE}
g = ggplot(mtcars, aes(x=hp, y=mpg, color = am, size = wt)) +
    geom_point(alpha=.5) + 
    geom_smooth(method = "lm", size = 2) +
    geom_vline(xintercept = mean(automatic$hp), color = "cyan", alpha=.5) +
    geom_hline(yintercept = mean(automatic$mpg), color = "cyan", alpha=.5) +
    geom_vline(xintercept = mean(manual$hp), color = "salmon", alpha=.5) +
    geom_hline(yintercept = mean(manual$mpg), color = "salmon", alpha=.5) +
    xlab("HP") + 
    ylab("Miles per gallon") + 
    ggtitle("Model3: Automatic vs Manual by HP & Weight")
g
```

**Grading criteria:**

* Did the student interpret the coefficients correctly?
* Did the student do some exploratory data analyses?
* Did the student fit multiple models and detail their strategy for model selection?
* Did the student answer the questions of interest or detail why the question(s) is (are) not answerable?
* Did the student do a residual plot and some diagnostics?
* Did the student quantify the uncertainty in their conclusions and/or perform an inference correctly?
* Was the report brief (about 2 pages long) for the main body of the report and no longer than 5 with supporting appendix of figures?
* Did the report include an executive summary?
* Was the report done in Rmd (knitr)?


# Executive Summary

