---
title: "Regression Models - Course Project"
output:
  pdf_document:
    fig_caption: yes
  html_document: default
includes:
  in_header: mystyles.sty
---

```{r, results="hide", echo=FALSE}
# Load libraries
library(dplyr, quietly=TRUE, warn.conflicts = FALSE)
suppressWarnings(library(scales, quietly=TRUE))
suppressWarnings(library(pander, quietly=TRUE))
library(ggplot2)
suppressWarnings(library(gridExtra, quietly=TRUE, warn.conflict=FALSE))

library(datasets)
```


```{r echo = FALSE}
data(mtcars)

#mtcars$am = as.character(mtcars$am)
#mtcars$trans <- 'M'
#mtcars[with(mtcars, am == 1),]$trans <- 'A'
automatic <- subset(mtcars, am == 1)
manual <- subset(mtcars, am == 0)
```

# Executive summary
Using the mtcars dataset I have modeled the impact of and automatic vs a manual transmission on MPG.  My best model includes the weight of the car and its engine power along with the transmission type.  This model predicts with with 95% certainty you can expect an improved MPG of **X**   

* "Is an automatic or manual transmission better for MPG"
* "Quantify the MPG difference between automatic and manual transmissions"

# Data exploration
The mtcars data set consists of `r nrow(mtcars)` rows, `r nrow(automatic)` with automatic and  `r nrow(manual)` with manual transmission.  Some key variables are:

* **mpg** = Miles(US)/gallon
* **am** = Transmission (0 = automatic, 1 = manual)
* **hp** = Gross horsepower 
* **wt** = Weight (lb/1000) 
* **cyl** = Number of cylinders
* **carb** = Number of carburators

The scatter plots in Figure \ref{fig:explore} have cars with automatic transmission in cyan and those with manual in salmon.  These plots explore the impact on MPG by some key factors. Weight and HP seems to have a large impact.  With both these plots we see that automatic cars generally have higher mpg, but it is clear that both weight and engine power has a negative impact on mpg. Lighter or smaller engine automatic cars seem to cluster in the upper left quadrant, and are more fuel efficient than heavy and/or powerful manual cars which seem overly represented in the lower right quadrant.  In both plots there are two high-hp and heavy outliers in the automatic segment, which both have poor mpg.

# Models

```{r echo = FALSE}
fit1 <- lm(mpg ~ factor(am), mtcars)
coef1 <- summary(fit1)$coef
panderOptions('table.split.table', Inf) 
pander(coef1, style="rmarkdown", caption="lm(mpg ~ factor(am), mtcars)")
```

The *factor(am)1* coeficcient, am=1:automatic, is interpreted with respect to *am=0*, manual.  According to this simple model, switching from manual to automatic transmission will **gain** you `r round(coef1[2,1], 3)` mpg.  Figure \ref{fig:mod1} shows how the mean mpg, automatic = `r round(mean(automatic$mpg), 3)` and manual = `r round(mean(manual$mpg), 3)`, differs in automatic's favour.  

```{r echo = FALSE}
fit2 <- lm(mpg ~ hp * factor(am), mtcars)
coef2 <- summary(fit2)$coef
panderOptions('table.split.table', Inf) 
pander(coef2, style="rmarkdown", caption="lm(mpg ~ hp * factor(am), mtcars)")
```

The initial exploration in Figure \ref{fig:explore} indicated that engine power (hp) likely has a negative an impact on fuel efficiency.  Many cars with large engines also had manual transmission.  The interpretation of this model is that adding 1 hp **decreases** fuel efficiency by `r abs(round(coef2[2,1], 3))` mpg.  Switching to automatic will now only *gain* you `r round(coef2[3,1], 3)` mpg, providing hp stays the same.  Figure \ref{fig:mod2} plots two regression lines, one for each transmission type.  The difference in intersection (manual = `r round(coef2[1,1], 3)`, automatic = `r round(coef2[1,1] + coef2[3,1], 3)`) is the effect of going automatic.  The last coefficient, *hp:factor(am)1*, is the *effect on hp* by going to automatic, which defines the slope of the line for automatic as $`r round(coef2[2,1], 5)` +  `r round(coef2[4,1],5)` = `r round((coef2[2,1] + coef2[4,1]), 4)`$.


```{r echo = FALSE}
fit3 <- lm(mpg ~ wt * factor(am), mtcars)
coef3 <- summary(fit3)$coef
panderOptions('table.split.table', Inf) 
pander(coef3, style="rmarkdown", caption="lm(mpg ~ wt * factor(am), mtcars)")
```

Having considered the impact of hp, let us now compare that with the impact of weight. As weight is listed in lb/1000 it is clear that adding one unit (1000lb) will have a disproportionaly large impact.  The interpretation is that adding 1000 lb of weight **decreases** fuel efficiency by `r abs(round(coef3[2,1], 3))` mpg.  Switching to automatic will now improve MPG by `r round(coef3[3,1], 3)`, providing weight stays the same.  Figure \ref{fig:mod3} plots two regression lines, one for each transmission type.  The difference in intersection (manual = `r round(coef3[1,1], 3)`, automatic = `r round(coef3[1,1] + coef3[3,1], 3)`) is the effect of going automatic.  The last coefficient, *hp:factor(am)1*, is the *effect on wp* by going to automatic, which defines the slope of the line for automatic as `r round(coef3[2,1], 3)` +  `r round(coef3[4,1], 3)` = `r round(coef3[2,1] + coef3[4,1], 3)`.  

```{r echo = FALSE}
fit4 <- lm(mpg ~ hp * factor(am) + wt * factor(am), mtcars)
coef4 <- summary(fit4)$coef

# Confidence interval for the intercept and the slope
am_ci <- coef4[3,1] + c(1,-1)*qt(.975, df=fit4$df) * coef4[3,2]
hp_ci <- coef4[2,1] + c(1,-1)*qt(.975, df=fit4$df) * coef4[2,2]
wt_ci <- coef4[4,1] + c(1,-1)*qt(.975, df=fit4$df) * coef4[4,2]

panderOptions('table.split.table', Inf) 
pander(coef4, style="rmarkdown", caption="lm(mpg ~ hp * factor(am) + wt * factor(am), mtcars)")
```

Heavy cars often come with large engines and many of these have manual transmission. This model accounts for weight *wt* as well as engine power *hp*.  We see that adding 1000lb of weight reduces mpg by `r abs(round(coef4[4,1], 3))`. Adding this third factor, reduces the impact of hp, so that adding one hp now only decreases mpg by `r abs(round(coef4[4,1], 3))`, but the impact of an automatic transmission is now larger and it is predicted to gain you `r round(coef4[3,1], 3)` mpg, provided hp and wt stays the same. Figure \ref{fig:mod4} in the appendix draws these relationship in a single plot. It includes confidence intervals for both lines and it has lines for their respective means of hp & mpg.

The confidence interval for the slope of the am predictor/coefficient (`r round(am_ci[1], 4)` ;  `r round(am_ci[2], 4)`) is quite large as can be seen in the plot.  The residual variance `r round(var(resid(fit4)), 4)` ($\sigma$ = `r round(summary(fit4)$sigma, 4)`), and the residual plots in Figure \ref{fig:resid} shows a vague "curved" trend indicating that a linear model might not be the best fit. Still: with a p-value of `r round(coef4[3,4], 3)` we can say with 95% certainty that a car with the same weight and horse power will improve mpg by `r round(coef4[3,1], 3)` by having an automatic transmission. 

# Appendix : plots

```{r explore, echo = FALSE, fig.height = 6, fig.cap="\\label{fig:explore}Exploratory plots of Automatic vs Manual transmissions with engine power or weight"}
# mtcars$am = as.character(mtcars$am)
g1 = ggplot(mtcars, aes(x=hp, y=mpg, color = factor(am), size = wt)) +
    geom_point(alpha=.5) + 
    xlab("hp") + 
    ylab("mpg") +
    theme(legend.position="bottom")

g2 = ggplot(mtcars, aes(x=wt, y=mpg, color = factor(am), size = hp)) +
    geom_point(alpha=.5) + 
    xlab("wt") + 
    ylab("mpg") +
    theme(legend.position="bottom")

g3 = ggplot(mtcars, aes(x=cyl, y=mpg, color = factor(am))) +
    geom_point(alpha=.5) + 
    theme(legend.position="bottom")

g4 = ggplot(mtcars, aes(x=carb, y=mpg, color = factor(am))) +
    geom_point(alpha=.5) + 
    theme(legend.position="bottom")

grid.arrange(g1, g2, g3, g4, ncol=2, nrow=2)
# mtcars$am = as.numeric(mtcars$am)
```

```{r mod1, echo = FALSE, fig.height = 3, fig.width=automatic, fig.cap="\\label{fig:mod1} lm(mpg ~ factor(am), mtcars)"}
ggplot(mtcars, aes(x=factor(am), y=mpg, color=factor(am))) +
    geom_point(alpha=.5) +
    geom_abline(intercept = coef(fit1)[1] - (1 * coef(fit1)[2]), slope = coef(fit1)[2], size = 1, color = "blue") +
    geom_hline(yintercept = mean(automatic$mpg), color = "cyan", alpha=.5) +
    geom_hline(yintercept = mean(manual$mpg), color = "salmon", alpha=.5) 
```

```{r mod2, echo = FALSE, fig.height = 4, fig.width=automatic, fig.cap="\\label{fig:mod2} lm(mpg ~ hp * factor(am), mtcars)"}
ggplot(mtcars, aes(x=hp, y=mpg, color=factor(am), size = wt)) +
    geom_point(alpha=.5) +
#    geom_abline(intercept = coef(fit2)[1], slope = coef(fit2)[2], size = 1, color = "salmon") +
#    geom_abline(intercept = coef(fit2)[1] + coef(fit2)[3], slope = coef(fit2)[2] + coef(fit2)[4], size = 1, color = "cyan") 
    geom_smooth(method = "lm", se = TRUE) 
#     geom_hline(yintercept = mean(automatic$mpg), color = "cyan", alpha=.5) +
#     geom_hline(yintercept = mean(manual$mpg), color = "salmon", alpha=.5) + 
#     geom_vline(xintercept = mean(automatic$hp), color = "cyan", alpha=.5) +
#     geom_vline(xintercept = mean(manual$hp), color = "salmon", alpha=.5)
```

```{r mod3, echo = FALSE, fig.height = 4, fig.width=automatic, fig.cap="\\label{fig:mod2} lm(mpg ~ wt * factor(am), mtcars)"}
ggplot(mtcars, aes(x=wt, y=mpg, color=factor(am), size = hp)) +
    geom_point(alpha=.5) +
#    geom_abline(intercept = coef(fit2)[1], slope = coef(fit2)[2], size = 1, color = "salmon") +
#    geom_abline(intercept = coef(fit2)[1] + coef(fit2)[3], slope = coef(fit2)[2] + coef(fit2)[4], size = 1, color = "cyan") 
     geom_smooth(method = "lm", se = TRUE) 
#     geom_hline(yintercept = mean(automatic$mpg), color = "cyan", alpha=.5) +
#     geom_hline(yintercept = mean(manual$mpg), color = "salmon", alpha=.5) + 
#     geom_vline(xintercept = mean(automatic$hp), color = "cyan", alpha=.5) +
#     geom_vline(xintercept = mean(manual$hp), color = "salmon", alpha=.5)
```

```{r mod4, echo = FALSE, fig.height = 4, fig.width=automatic, fig.cap="\\label{fig:mod3} lm(mpg ~ hp * factor(am) + wt * factor(am), mtcars)"}
ggplot(mtcars, aes(x=hp, y=mpg, size = wt, color=factor(am))) +
    geom_point(alpha=.5) +
    geom_smooth(method = "lm", size = 1) +
    geom_hline(yintercept = mean(automatic$mpg), color = "cyan", alpha=.5) +
    geom_hline(yintercept = mean(manual$mpg), color = "salmon", alpha=.5) + 
    geom_vline(xintercept = mean(automatic$hp), color = "cyan", alpha=.5) +
    geom_vline(xintercept = mean(manual$hp), color = "salmon", alpha=.5)
```

```{r resid, echo = FALSE, fig.height = 4, fig.width=automatic, fig.cap="\\label{fig:resid}Residual plots for model 3"}
mtcars$Residual <- resid(fit3) 
g1 <- ggplot(mtcars, aes(x=hp, y=Residual, size=wt, color=factor(am))) +
      geom_point(alpha=.5) + 
      geom_hline(yintercept = 0, color = "black") +
      theme(legend.position="bottom")
g2 <- ggplot(mtcars, aes(x=wt, y=Residual, size=hp, color=factor(am))) +
      geom_point(alpha=.5) + 
      geom_hline(yintercept = 0, color = "black") +
      theme(legend.position="bottom")
grid.arrange(g1, g2, ncol=2)
```


# Initial draft
```{r echo = FALSE}
afit <- lm(mpg ~ I(hp - mean(hp)), automatic)
acoef <- summary(afit)$coef
panderOptions('table.split.table', Inf) 
pander(acoef, style="rmarkdown", caption="Model3 Coefficients for Automatic (centered at mean hp)")

mfit <- lm(mpg ~ I(hp - mean(hp)), manual)
mcoef <- summary(mfit)$coef
panderOptions('table.split.table', Inf) 
pander(mcoef, style="rmarkdown", caption="LM Coefficients for Manual (centered at mean hp)")
```

An *automatic* car of average engine power, `r round(mean(automatic$hp), 0)` hp, runs `r round(mean(automatic$mpg), 2)` mpg, compared to *manual* cars of average engine power, `r round(mean(manual$hp), 0)`hp, runs `r round(mean(manual$mpg), 2)` mpg.  Manual cars do tend to have larger engines which do consume more fuel, but adding an additional HP of engine power to an automatic car will result in `r round(acoef[2,1], 4)` change in MPG, which is very similar to manual cars (`r round(mcoef[2,1], 4)`), assuming we ignore weight in this data set.

#### Interpretation of Coefficients.   
Our model estimates a decrease of `r abs(round(acoef[2,1], 4))` miles per gallon for every 1 added horse power to a car with an automatic transmission, and a decrease of `r abs(round(mcoef[2,1], 4))` miles per gallon for every 1 added horse power to a car with a manual transmission.

From the slope alone there is not much difference in fuel efficiency between the transmission types, but from the scatterplot we see that the confidence interval is much wider for automatic than it is for manual cars.The below plot of the residuals will shows the difference in spread here.

```{r echo = FALSE}
automatic$Residual <- resid(afit) 
manual$Residual <- resid(mfit) 

ga = ggplot(automatic, aes(x=hp, y=Residual, size = wt)) +
    geom_point(alpha=.5, color = "cyan") + 
    geom_hline(yintercept = 0, color = "black") +
    ggtitle("Automatic Residuals")
#    xlab("HP") + 
#    ylab("Miles per gallon") + 

gm = ggplot(manual, aes(x=hp, y=Residual, size = wt)) +
    geom_point(alpha=.5, color = "salmon") + 
    geom_hline(yintercept = 0, color = "black") +
    ggtitle("Manual Residuals")

grid.arrange(ga, gm, nrow=2)

```

```{r}
# Confidence interval for the intercept and the slope
aintercept_ci <- acoef[1,1] + c(1,-1)*qt(.975, df=afit$df) * acoef[1,2]
aslope_ci <- acoef[2,1] + c(1,-1)*qt(.975, df=afit$df) * acoef[2,2]

mintercept_ci <- mcoef[1,1] + c(1,-1)*qt(.975, df=mfit$df) * mcoef[1,2]
mslope_ci <- mcoef[2,1] + c(1,-1)*qt(.975, df=mfit$df) * mcoef[2,2]
```

## MPG difference between automatic and manual transmission

| Transmission type | MPG $\Delta$ per added HP | Conf int (slope) | $\sigma$ / Residual variability |
|:-----------------:|:---------------------------:|:---------------:|:-----------------:|
| Automatic         | `r round(acoef[2,1], 4)`    |  (`r round(aslope_ci[1], 4)`;  `r round(aslope_ci[2], 4)`)  | `r round(summary(afit)$sigma, 4)`  |
| Manual            | `r round(mcoef[2,1], 4)`    | (`r round(mslope_ci[1], 4)`; `r round(mslope_ci[2], 4)`)  | `r round(summary(mfit)$sigma, 4)`  |


